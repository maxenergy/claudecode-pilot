/**
 * Templates Module
 *
 * Handles template file operations
 */

const fs = require('fs');
const path = require('path');
const { ensureDirectory, fileExists } = require('./utils');

/**
 * Get template file path
 * @param {string} templateName - Name of the template
 * @returns {string} Full path to template file
 */
function getTemplatePath(templateName) {
  // Templates are in the examples/ directory of the package
  const templatesDir = path.join(__dirname, '..', 'examples');
  return path.join(templatesDir, templateName);
}

/**
 * Replace variables in content
 * @param {string} content - Template content
 * @param {Object} variables - Variables to replace
 * @returns {string} Content with variables replaced
 */
function replaceVariables(content, variables = {}) {
  let result = content;

  // Replace each variable
  for (const [key, value] of Object.entries(variables)) {
    const placeholder = `{{${key}}}`;
    const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    result = result.replace(regex, value);
  }

  return result;
}

/**
 * Copy template to target directory
 * @param {string} templateName - Name of the template
 * @param {string} targetPath - Target file path
 * @param {Object} variables - Variables to replace in template
 */
function copyTemplate(templateName, targetPath, variables = {}) {
  const templatePath = getTemplatePath(templateName);

  // Check if template exists
  if (!fileExists(templatePath)) {
    throw new Error(`Template not found: ${templateName}`);
  }

  // Read template content
  let content = fs.readFileSync(templatePath, 'utf8');

  // Replace variables
  content = replaceVariables(content, variables);

  // Ensure target directory exists
  const targetDir = path.dirname(targetPath);
  ensureDirectory(targetDir);

  // Write to target
  fs.writeFileSync(targetPath, content);
}

/**
 * Copy all templates to target directory
 * Following Claude Code official structure: .claude/commands/
 * @param {string} targetDir - Target directory
 * @param {Object} variables - Variables to replace in templates
 */
function copyAllTemplates(targetDir, variables = {}) {
  // Claude Code official commands directory
  const commandsDir = path.join(targetDir, '.claude', 'commands');
  const toolsDir = path.join(targetDir, '.claude', 'tools');

  // List of command template files to copy
  const commandTemplates = [
    { source: 'product-owner.md.template', target: 'product-owner.md' },
    { source: 'architect.md.template', target: 'architect.md' },
    { source: 'tech-lead.md.template', target: 'tech-lead.md' },
    { source: 'developer.md.template', target: 'developer.md' },
    { source: 'tester.md.template', target: 'tester.md' },
    { source: 'reviewer.md.template', target: 'reviewer.md' },
    { source: 'debugger.md.template', target: 'debugger.md' }
  ];

  // Copy each command template to .claude/commands/
  for (const template of commandTemplates) {
    const sourcePath = getTemplatePath(template.source);
    const targetPath = path.join(commandsDir, template.target);

    // Only copy if source exists
    if (fileExists(sourcePath)) {
      copyTemplate(template.source, targetPath, variables);
    } else {
      // Create placeholder if template doesn't exist yet
      createPlaceholderCommand(targetPath, template.target, variables);
    }
  }

  // Copy task.js to .claude/tools/
  const taskJsSource = path.join(__dirname, '..', '.claude-pilot', 'tools', 'task.js');
  const taskJsTarget = path.join(toolsDir, 'task.js');

  if (fileExists(taskJsSource)) {
    fs.copyFileSync(taskJsSource, taskJsTarget);
  }
}

/**
 * Create placeholder command (Claude Code slash command format)
 * @param {string} targetPath - Target file path
 * @param {string} commandName - Command name
 * @param {Object} variables - Variables
 */
function createPlaceholderCommand(targetPath, commandName, variables = {}) {
  const agentName = commandName.replace('.md', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  const commandSlug = commandName.replace('.md', '');

  const placeholder = `---
description: ${agentName} Agent for {{PROJECT_NAME}}
allowed-tools: Bash(*), ReadFiles(*), WriteFiles(*)
---

# ${agentName} Agent

You are the **${agentName}** for the {{PROJECT_NAME}} project.

## Your Role

As the ${agentName}, you are responsible for:

- Define responsibilities here
- Add more responsibilities

## Workflow

Follow these steps:

1. **Step 1**: Description
2. **Step 2**: Description
3. **Step 3**: Description

## Output

Create or update the following files:

- \`docs/${commandSlug}_output.md\` - Main output document
- Other relevant files

## Guidelines

- Follow best practices
- Maintain consistency
- Document your decisions

---

*Generated by Claude Code GPT-Pilot on {{DATE}}*
`;

  const content = replaceVariables(placeholder, variables);
  ensureDirectory(path.dirname(targetPath));
  fs.writeFileSync(targetPath, content);
}

/**
 * Get default variables
 * @param {string} projectName - Project name
 * @returns {Object} Default variables
 */
function getDefaultVariables(projectName) {
  return {
    PROJECT_NAME: projectName,
    DATE: new Date().toISOString().split('T')[0],
    YEAR: new Date().getFullYear().toString(),
    AUTHOR: 'Claude Code GPT-Pilot'
  };
}

module.exports = {
  getTemplatePath,
  replaceVariables,
  copyTemplate,
  copyAllTemplates,
  getDefaultVariables
};

