/**
 * Init Command
 *
 * Initializes a new Claude Code GPT-Pilot project
 */

const path = require('path');
const fs = require('fs');
const { ensureDirectory } = require('../utils');
const { copyAllTemplates, getDefaultVariables } = require('../templates');

/**
 * Initialize a new project
 * @param {Object} options - Command options
 */
async function init(options) {
  const projectName = options.name || path.basename(process.cwd());
  const targetDir = options.dir ? path.resolve(options.dir) : process.cwd();

  console.log('ðŸš€ Initializing Claude Code GPT-Pilot project...');
  console.log(`ðŸ“ Project: ${projectName}`);
  console.log(`ðŸ“‚ Directory: ${targetDir}\n`);

  try {
    // Prepare variables for templates
    const variables = getDefaultVariables(projectName);

    // Step 1: Create .claude-pilot directory structure
    console.log('ðŸ“¦ Creating .claude-pilot directory structure...');
    createClaudePilotStructure(targetDir);
    console.log('âœ… .claude-pilot structure created\n');

    // Step 2: Create project directories
    console.log('ðŸ“ Creating project directories...');
    createProjectDirectories(targetDir);
    console.log('âœ… Project directories created\n');

    // Step 3: Generate basic files
    console.log('ðŸ“ Generating basic files...');
    generateBasicFiles(targetDir, projectName);
    console.log('âœ… Basic files generated\n');

    // Step 4: Copy template files
    console.log('ðŸ“‹ Copying Agent templates...');
    copyAllTemplates(targetDir, variables);
    console.log('âœ… Agent templates copied\n');

    // Success message
    console.log('ðŸŽ‰ Project initialized successfully!');
    console.log('\nðŸ“š Next steps:');
    console.log('  1. Review the generated CLAUDE.md file');
    console.log('  2. Run /product-owner in Claude Code to start defining requirements');
    console.log('  3. Follow the Agent workflow to build your project\n');

  } catch (error) {
    console.error('âŒ Error initializing project:', error.message);
    process.exit(1);
  }
}

/**
 * Create .claude-pilot directory structure
 * @param {string} targetDir - Target directory
 */
function createClaudePilotStructure(targetDir) {
  const claudePilotDir = path.join(targetDir, '.claude-pilot');

  // Create main directories
  ensureDirectory(claudePilotDir);
  ensureDirectory(path.join(claudePilotDir, 'agents'));
  ensureDirectory(path.join(claudePilotDir, 'templates'));
  ensureDirectory(path.join(claudePilotDir, 'tools'));

  // Create agents.json
  const agentsConfig = {
    agents: [
      { id: 'product-owner', name: 'Product Owner', template: 'product-owner.md' },
      { id: 'architect', name: 'Architect', template: 'architect.md' },
      { id: 'tech-lead', name: 'Tech Lead', template: 'tech-lead.md' },
      { id: 'developer', name: 'Developer', template: 'developer.md' },
      { id: 'tester', name: 'Tester', template: 'tester.md' },
      { id: 'reviewer', name: 'Reviewer', template: 'reviewer.md' },
      { id: 'debugger', name: 'Debugger', template: 'debugger.md' }
    ]
  };

  fs.writeFileSync(
    path.join(claudePilotDir, 'agents', 'agents.json'),
    JSON.stringify(agentsConfig, null, 2)
  );

  // Create context_memory.json
  const contextMemory = {
    project_context: {},
    agent_history: [],
    last_updated: new Date().toISOString()
  };

  fs.writeFileSync(
    path.join(claudePilotDir, 'context_memory.json'),
    JSON.stringify(contextMemory, null, 2)
  );

  // Create README.md in .claude-pilot
  const claudePilotReadme = `# .claude-pilot Directory

This directory contains the Claude Code GPT-Pilot system files.

## Structure

- \`agents/\` - Agent configuration and metadata
- \`templates/\` - Agent prompt templates
- \`tools/\` - Task management and utility scripts
- \`context_memory.json\` - Shared context between agents

## Do Not Modify

These files are managed by the Claude Code GPT-Pilot system.
Manual modifications may cause unexpected behavior.
`;

  fs.writeFileSync(
    path.join(claudePilotDir, 'README.md'),
    claudePilotReadme
  );
}

/**
 * Create project directories
 * @param {string} targetDir - Target directory
 */
function createProjectDirectories(targetDir) {
  ensureDirectory(path.join(targetDir, 'docs'));
  ensureDirectory(path.join(targetDir, 'src'));
  ensureDirectory(path.join(targetDir, 'tests'));
}

/**
 * Generate basic files
 * @param {string} targetDir - Target directory
 * @param {string} projectName - Project name
 */
function generateBasicFiles(targetDir, projectName) {
  // Generate README.md
  const readme = `# ${projectName}

> Generated by Claude Code GPT-Pilot

## About

This project was initialized with Claude Code GPT-Pilot, an AI-powered software development lifecycle management system.

## Getting Started

1. Open this project in Claude Code
2. Review the \`CLAUDE.md\` file for available commands
3. Start with \`/product-owner\` to define your requirements

## Project Structure

- \`docs/\` - Project documentation
- \`src/\` - Source code
- \`tests/\` - Test files
- \`.claude-pilot/\` - GPT-Pilot system files

## Workflow

1. **Product Owner** - Define requirements
2. **Architect** - Design architecture
3. **Tech Lead** - Break down tasks
4. **Developer** - Implement features
5. **Tester** - Write and run tests
6. **Reviewer** - Review code
7. **Debugger** - Fix issues

## Documentation

- [Product Requirements](docs/product_requirements.md) - Generated by Product Owner
- [Architecture](docs/architecture.md) - Generated by Architect
- [Tasks](tasks.md) - Generated by Tech Lead

## License

MIT
`;

  fs.writeFileSync(path.join(targetDir, 'README.md'), readme);

  // Generate basic CLAUDE.md (will be enhanced in M1-T003)
  const claudeMd = `# Claude Code GPT-Pilot Commands

This file defines the available slash commands for Claude Code.

## Available Commands

- \`/product-owner\` - Define product requirements
- \`/architect\` - Design system architecture
- \`/tech-lead\` - Break down tasks
- \`/developer [task-id]\` - Implement a task
- \`/developer-auto [start-task-id]\` - Auto-execute tasks
- \`/tester [task-id]\` - Write and run tests
- \`/reviewer [task-id]\` - Review code changes
- \`/debugger\` - Debug issues

## Usage

Type any command above in Claude Code to activate the corresponding Agent.

---

*Note: Full command definitions will be added in the next step.*
`;

  fs.writeFileSync(path.join(targetDir, 'CLAUDE.md'), claudeMd);
}

module.exports = init;

